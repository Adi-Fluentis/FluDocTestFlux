name: Update Project Fields

on:
 workflow_dispatch: # Manual trigger

jobs:
  update_project_fields:
    runs-on: ubuntu-latest
    steps:
      - name: Debug GitHub Token Permissions
        run: |
          curl -H "Authorization: Bearer ${{ secrets.GH_PAT }}" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/orgs/Adi-Fluentis/projects

      - name: Update Progress, Weight & Completed Weight
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const issue = context.payload.issue;
            const repo = context.repo;
            const owner = repo.owner;
            const repoName = repo.repo;
            const issueNumber = issue.number;
            const issueBody = issue.body || "";  // Ensure issueBody is always a string

            console.log("ðŸ”¹ Issue Number:", issueNumber);

            // Extract estimated word count from issue body
            const wordCountMatch = issueBody.match(/Estimated Word Count:\s*([\d,]+)/);
            const totalWords = wordCountMatch ? parseInt(wordCountMatch[1].replace(/,/g, ''), 10) : 0;

            if (totalWords === 0) {
              console.log("âŒ No word count found, skipping update.");
              return;
            }

            console.log("ðŸ“Š Total Words in Issue:", totalWords);

            // Find completed tasks and sum words
            let completedWords = 0;
            const allCheckboxes = issueBody.match(/- \[[ x]\] \*\*(.*?)\*\* \(([\d,]+) words\)/g) || [];

            allCheckboxes.forEach(line => {
              if (line.includes("- [x]")) {
                const wordMatch = line.match(/\(([\d,]+) words\)/);
                if (wordMatch) {
                  completedWords += parseInt(wordMatch[1].replace(/,/g, ''), 10) || 0;
                }
              }
            });

            console.log("âœ… Completed Words:", completedWords);

            // Compute percentage
            const progressPercent = totalWords > 0 ? Math.round((completedWords / totalWords) * 100) : 0;
            console.log("ðŸ“Š Progress Calculated:", progressPercent, "%");

            console.log("âœ… Progress field updated.");

